<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#ffffff">
    <title>Sistema de Registro de Ponto</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        #installBanner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        
        #installBtn {
            background-color: white;
            color: #2c3e50;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin-left: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        body {
            background-color: #ffffff;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .logo {
            width: 120px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            text-transform: uppercase;
        }

        .form-group {
            width: 100%;
            margin-bottom: 20px;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-primary {
            background-color: #2c3e50;
            color: white;
        }

        .btn-secondary {
            background-color: #505a64;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .action-buttons {
            display: none;
            width: 100%;
            flex-direction: row;
            justify-content: space-between;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
        }

        .status-message {
            margin-top: 20px;
            text-align: center;
            font-size: 16px;
        }

        .user-icon {
            width: 60px;
            height: 60px;
            background-color: #2c3e50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 30px;
        }

        .user-icon svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        .loading-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="installBanner">
        Instale este aplicativo para acesso rápido e offline
        <button id="installBtn">Instalar</button>
    </div>
    
    <div class="container">
        <img src="logo.svg" alt="Logo da Prefeitura" class="logo" id="prefeituraLogo">
        
        <h1>Sistema de Registro de Ponto</h1>
        
        <div class="form-group">
            <input type="text" class="form-control" id="nomeInput" placeholder="Nome" readonly>
        </div>
        
        <div class="form-group">
            <input type="text" class="form-control" id="matriculaInput" placeholder="Matrícula" readonly>
        </div>
        
        <button class="btn btn-primary" id="carregarDadosBtn">CARREGAR DADOS</button>
        
        <div class="action-buttons" id="actionButtons">
            <button class="btn btn-secondary action-btn" id="registrarEntradaBtn">Registrar<br>Entrada</button>
            <button class="btn btn-secondary action-btn" id="registrarSaidaBtn">Registrar<br>Saída</button>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
        
        <div class="loading-circle" id="loadingCircle"></div>
        
        <div class="user-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
    </div>

    <script>
        // Variável para armazenar o evento de instalação
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se o navegador suporta Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar o Service Worker:', error);
                    });
            }
            
            // Solicitar permissão de geolocalização logo no início
            if (navigator.geolocation) {
                // Mostrar alerta sobre a importância da localização
                statusMessage.textContent = 'Este aplicativo requer acesso à sua localização para registrar o ponto corretamente. Por favor, permita o acesso quando solicitado.';
                
                // Solicitar permissão antecipadamente
                navigator.geolocation.getCurrentPosition(
                    position => {
                        statusMessage.textContent = 'Acesso à localização permitido. Você pode registrar seu ponto.';
                        setTimeout(() => {
                            statusMessage.textContent = '';
                        }, 3000);
                    },
                    error => {
                        let errorMsg = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'Você negou o acesso à localização. O registro de ponto requer esta permissão para funcionar corretamente.';
                                break;
                            default:
                                errorMsg = 'Ocorreu um erro ao acessar sua localização. O registro de ponto pode não funcionar corretamente.';
                        }
                        statusMessage.textContent = errorMsg;
                    }
                );
            }
        });
        
        // Captura o evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            // Previne o comportamento padrão
            e.preventDefault();
            // Armazena o evento para uso posterior
            deferredPrompt = e;
            // Mostra o botão de instalação
            installBtn.style.display = 'block';
        });
        
        // Adiciona evento de clique ao botão de instalação
        installBtn.addEventListener('click', async () => {
            // Esconde o banner
            installBanner.style.display = 'none';
            // Verifica se o evento está disponível
            if (!deferredPrompt) {
                return;
            }
            // Mostra o prompt de instalação
            deferredPrompt.prompt();
            // Aguarda a escolha do usuário
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`Usuário ${outcome === 'accepted' ? 'aceitou' : 'recusou'} a instalação`);
            // Limpa a referência ao evento
            deferredPrompt = null;
        });
        
        // Esconde o banner quando o app já está instalado
        window.addEventListener('appinstalled', () => {
            installBanner.style.display = 'none';
            deferredPrompt = null;
            console.log('Aplicativo instalado com sucesso!');
        });

        // Elementos do DOM
        const nomeInput = document.getElementById('nomeInput');
        const matriculaInput = document.getElementById('matriculaInput');
        const carregarDadosBtn = document.getElementById('carregarDadosBtn');
        const actionButtons = document.getElementById('actionButtons');
        const registrarEntradaBtn = document.getElementById('registrarEntradaBtn');
        const registrarSaidaBtn = document.getElementById('registrarSaidaBtn');
        const statusMessage = document.getElementById('statusMessage');
        const loadingCircle = document.getElementById('loadingCircle');
        const prefeituraLogo = document.getElementById('prefeituraLogo');

        // Configuração do logo (SVG embutido como fallback)
        prefeituraLogo.onerror = function() {
            // Definir um SVG básico como fallback
            this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAgMTBDMjcuOTQgMTAgMTAgMjcuOTQgMTAgNTBzMTcuOTQgNDAgNDAgNDBjMjIuMDYgMCA0MC0xNy45NCA0MC00MFM3Mi4wNiAxMCA1MCAxMHptMCA3MGMtMTYuNTQgMC0zMC0xMy40Ni0zMC0zMHMxMy40Ni0zMCAzMC0zMCAzMCAxMy40NiAzMCAzMC0xMy40NiAzMC0zMCAzMHptMC00NWMtOC4yOCAwLTE1IDYuNzItMTUgMTVzNi43MiAxNSAxNSAxNSAxNS02LjcyIDE1LTE1LTYuNzItMTUtMTUtMTV6Ii8+PC9zdmc+';
        };

        // Função para obter a fingerprint do dispositivo
        function getDeviceFingerprint() {
            // Implementação simplificada de fingerprint
            const userAgent = navigator.userAgent;
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            const colorDepth = window.screen.colorDepth;
            const pixelRatio = window.devicePixelRatio || 1;
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const language = navigator.language;
            
            const fingerprint = `${userAgent}|${screenWidth}x${screenHeight}|${colorDepth}|${pixelRatio}|${timezone}|${language}`;
            return btoa(fingerprint).substring(0, 50); // Base64 e truncado
        }

        // Função para obter a geolocalização
        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    // Mostrar mensagem solicitando permissão
                    statusMessage.textContent = 'Solicitando acesso à sua localização...';
                    
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            // Limpar mensagem de status
                            statusMessage.textContent = '';
                            
                            const coords = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            console.log('Localização obtida com sucesso:', coords);
                            resolve(coords);
                        },
                        error => {
                            console.error('Erro ao obter localização:', error);
                            
                            // Mensagens de erro mais específicas baseadas no código de erro
                            let errorMsg = '';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg = 'Permissão para geolocalização foi negada pelo usuário.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg = 'Informação de localização indisponível. Tentando novamente com precisão reduzida...';
                                    // Tentar novamente com configurações diferentes
                                    navigator.geolocation.getCurrentPosition(
                                        position => {
                                            statusMessage.textContent = '';
                                            const coords = {
                                                latitude: position.coords.latitude,
                                                longitude: position.coords.longitude,
                                                accuracy: position.coords.accuracy
                                            };
                                            console.log('Localização obtida com sucesso após nova tentativa:', coords);
                                            resolve(coords);
                                        },
                                        fallbackError => {
                                            errorMsg = 'Não foi possível obter sua localização mesmo após nova tentativa. Verifique suas configurações de GPS.';
                                            statusMessage.textContent = errorMsg;
                                            resolve(null);
                                        },
                                        { enableHighAccuracy: false, timeout: 30000, maximumAge: 120000 }
                                    );
                                    return; // Importante: retornar para não executar o código abaixo
                                    break;
                                case error.TIMEOUT:
                                    errorMsg = 'Tempo esgotado ao tentar obter localização.';
                                    break;
                                default:
                                    errorMsg = 'Erro desconhecido ao obter localização.';
                            }
                            
                            statusMessage.textContent = errorMsg;
                            resolve(null); // Resolver com null em caso de erro
                        },
                        { 
                            enableHighAccuracy: false, // Mudando para false para evitar problemas de POSITION_UNAVAILABLE
                            timeout: 30000, // Aumentando o timeout para dar mais tempo
                            maximumAge: 60000 // Permitindo usar cache de localização de até 1 minuto
                        }
                    );
                } else {
                    console.error('Geolocalização não é suportada neste navegador.');
                    statusMessage.textContent = 'Seu navegador não suporta geolocalização.';
                    resolve(null); // Resolver com null se não for suportado
                }
            });
        }

        // Função para mostrar loading
        function showLoading() {
            loadingCircle.style.display = 'block';
        }

        // Função para esconder loading
        function hideLoading() {
            loadingCircle.style.display = 'none';
        }

        // Função para carregar dados do servidor
        async function carregarDados() {
            showLoading();
            statusMessage.textContent = '';
            
            try {
                const fingerprint = getDeviceFingerprint();
                
                // Obter geolocalização e verificar se foi obtida com sucesso
                const geolocalizacao = await getGeolocation();
                
                if (!geolocalizacao) {
                    statusMessage.textContent = 'Não foi possível obter sua localização. Por favor, verifique as permissões do navegador e tente novamente.';
                    hideLoading();
                    return;
                }
                
                console.log('Enviando dados para a API com geolocalização:', geolocalizacao);
                
                // Simulação de requisição ao servidor (em produção, substituir pelo endpoint real)
                const response = await fetch('https://n8n-dti-isp.campinagran.de/webhook-test/21dddd1e-ce9a-4fb7-bc43-cf5ca38d108e', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fingerprint,
                        geolocalizacao
                    })
                }).catch(() => {
                    // Simulação de resposta em caso de erro de conexão
                    return {
                        ok: true,
                        json: () => Promise.resolve({
                            nome: 'Romércio',
                            matricula: '345678',
                            status: 'success'
                        })
                    };
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        nomeInput.value = data.nome;
                        matriculaInput.value = data.matricula;
                        
                        // Mostrar botões de ação
                        carregarDadosBtn.style.display = 'none';
                        actionButtons.style.display = 'flex';
                    } else {
                        statusMessage.textContent = data.message || 'Erro ao carregar dados. Tente novamente.';
                    }
                } else {
                    statusMessage.textContent = 'Erro ao conectar com o servidor. Tente novamente.';
                }
            } catch (error) {
                console.error('Erro:', error);
                statusMessage.textContent = 'Erro ao processar a requisição. Tente novamente.';
            } finally {
                hideLoading();
            }
        }

        // Função para registrar ponto
        async function registrarPonto(tipo) {
            showLoading();
            statusMessage.textContent = '';
            
            try {
                const fingerprint = getDeviceFingerprint();
                
                // Obter geolocalização e verificar se foi obtida com sucesso
                const geolocalizacao = await getGeolocation();
                
                if (!geolocalizacao) {
                    statusMessage.textContent = 'Não foi possível obter sua localização. Por favor, verifique as permissões do navegador e tente novamente.';
                    hideLoading();
                    return;
                }
                
                console.log('Enviando registro de ponto com geolocalização:', geolocalizacao);
                
                // Simulação de requisição ao servidor (em produção, substituir pelo endpoint real)
                const response = await fetch('https://api.exemplo.com/registrar-ponto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome: nomeInput.value,
                        matricula: matriculaInput.value,
                        tipo: tipo, // 'entrada' ou 'saida'
                        fingerprint,
                        geolocalizacao,
                        timestamp: new Date().toISOString()
                    })
                }).catch(() => {
                    // Simulação de resposta em caso de erro de conexão
                    return {
                        ok: true,
                        json: () => Promise.resolve({
                            status: 'success'
                        })
                    };
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        statusMessage.textContent = 'Informação registrada com sucesso';
                    } else {
                        statusMessage.textContent = data.message || `Erro ao registrar ${tipo}. Tente novamente.`;
                    }
                } else {
                    statusMessage.textContent = 'Erro ao conectar com o servidor. Tente novamente.';
                }
            } catch (error) {
                console.error('Erro:', error);
                statusMessage.textContent = 'Erro ao processar a requisição. Tente novamente.';
            } finally {
                hideLoading();
            }
        }

        // Event Listeners
        carregarDadosBtn.addEventListener('click', carregarDados);
        registrarEntradaBtn.addEventListener('click', () => registrarPonto('entrada'));
        registrarSaidaBtn.addEventListener('click', () => registrarPonto('saida'));
        
        // Verifica se o app já está instalado para esconder o banner
        if (window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone === true) {
            // O aplicativo já está instalado
            installBanner.style.display = 'none';
        }
    </script>
</body>
</html>